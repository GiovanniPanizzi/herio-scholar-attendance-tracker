<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registra Presenza | SIGI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold mb-2 text-gray-800">Registrazione Presenza</h1>
        <h2 id="lesson-info" class="text-sm font-medium mb-6 text-indigo-600"></h2>

        <form id="attendance-form" class="flex flex-col gap-4">
            <!-- ID Lezione (Pre-popolato dall'URL) -->
            <input type="text" id="lezioneId" name="lezioneId" placeholder="ID Lezione" required
                   class="p-3 border border-gray-300 rounded-lg w-full" readonly>

            <!-- Token (Pre-popolato dall'URL) -->
            <input type="text" id="token" name="token" placeholder="Token" required
                   class="p-3 border border-gray-300 rounded-lg w-full" readonly>

            <!-- Matricola -->
            <input type="text" name="matricola" id="matricola" placeholder="Matricola (es. 123456)" required
                   class="p-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-indigo-500 transition">
            
            <p id="status" class="text-sm font-semibold h-5"></p>

            <button type="submit" id="btn" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg transition duration-150">
                Registra Presenza
            </button>
        </form>

    </div>

    <div id="success-popup" class="popup-success">
        <div class="popup-content">
            <h2 class="text-3xl font-bold text-green-600 mb-2">Registrazione completata ✅</h2>
            <p class="text-gray-700 mb-6">La tua presenza è stata registrata con successo.</p>
            <button id="close-success" 
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">
                Chiudi
            </button>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin; 
        const API_ENDPOINT = `${API_URL}/verifica-token`; 
    
        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const tokenFromURL = params.get('token');
            const lezioneIdFromURL = params.get('lezione'); 
    
            const btn = document.getElementById("btn");
            const matricolaInput = document.getElementById("matricola");
            const tokenInput = document.getElementById("token");
            const lezioneIdInput = document.getElementById("lezioneId");
            const statusMsg = document.getElementById("status");
            const lessonInfo = document.getElementById("lesson-info");
            
            if (!tokenFromURL || !lezioneIdFromURL) {
                lessonInfo.textContent = "Errore: Dati mancanti (Token e ID Lezione non trovati).";
                lessonInfo.classList.remove('text-indigo-600');
                lessonInfo.classList.add('text-red-500');
                btn.disabled = true;
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                return;
            }
            
            tokenInput.value = tokenFromURL;
            lezioneIdInput.value = lezioneIdFromURL;
            lessonInfo.textContent = `ID Lezione: ${lezioneIdFromURL}`;
    
            function showError(message, input = matricolaInput) { 
                statusMsg.textContent = message;
                statusMsg.classList.add("text-red-500");
                statusMsg.classList.remove("text-green-600"); 
                input.classList.add("input-error");
                input.classList.remove("border-gray-300");
            }
    
            function showSuccess(message) {
                statusMsg.textContent = message;
                statusMsg.classList.add("text-green-600");
                statusMsg.classList.remove("text-red-500");
            }
            
            function clearValidationStyles() {
                statusMsg.textContent = "";
                statusMsg.classList.remove("text-red-500", "text-green-600");
                matricolaInput.classList.remove("input-error");
                matricolaInput.classList.add("border-gray-300");
            }

            const inviaPresenza = async (e) => {
                e.preventDefault(); 
                clearValidationStyles();
    
                const matricola = matricolaInput.value.trim();
                const token = tokenInput.value.trim();
                const lezioneId = lezioneIdInput.value;
                
                if (!matricola || !/^\d{6}$/.test(matricola)) {
                    showError("Inserisci una matricola valida di 6 cifre.", matricolaInput);
                    return;
                }
                
                statusMsg.textContent = "Invio in corso...";
                statusMsg.classList.add("text-gray-500");
                
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
    
                try {

                    const res = await fetch(API_ENDPOINT, { 
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},

                        body: JSON.stringify({ matricola, token, lezioneId }) 
                    });
                    
                    const data = await res.json();
                    
                    if (res.ok) {
                        showSuccess(data.message || "Presenza registrata con successo.");
                        
                        document.getElementById("success-popup").classList.add("active");
                        matricolaInput.value = '';
                        clearValidationStyles(); 
                    } else {
                        showError(data.error || "Errore sconosciuto dal server.");
                    }
    
                } catch (e) {
                    console.error("Errore di connessione o fetch:", e);
                    showError("Errore di connessione al server.");
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            };
            
            document.getElementById('attendance-form').addEventListener('submit', inviaPresenza);

            document.getElementById('close-success').onclick = () => {
                document.getElementById("success-popup").classList.remove("active");
                clearValidationStyles();
            };

            matricolaInput.addEventListener("input", clearValidationStyles);
            
            clearValidationStyles();
        });
    </script>
</body>
</html>