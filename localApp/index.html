<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Presenze</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        Registro Presenze
        <button id="addClassBtn">+</button>
    </header>
    
    <main>
        <!-- Lista classi -->
        <div class="classes-grid" id="classesGrid"></div>

        <!-- Modal creazione classe -->
        <div id="modalOverlay" class="modal-overlay">
            <div id="modal" class="modal">
                <input type="text" id="newClassName" placeholder="Nome classe" />
                <button id="createClassBtn">Crea Classe</button>
            </div>
        </div>

        <!-- Dettaglio classe -->
        <div id="classDetail" style="display:none;">
            <h2 id="className"></h2>
            <button id="backToClasses">← Torna alle classi</button>
            <button id="addStudentBtn">Aggiungi Studente</button>
            <ul id="studentList"></ul>

            <h3>Lezioni</h3>
            <button id="createLessonBtn">Crea Lezione</button>
            <ul id="lezioniList"></ul>
        </div>

        <!-- Modal aggiunta studente -->
        <div id="studentModalOverlay" class="modal-overlay" style="display:none;">
            <div id="studentModal" class="modal">
                <input type="text" id="studentMatricola" placeholder="Matricola" />
                <input type="text" id="studentName" placeholder="Nome" />
                <input type="text" id="studentSurname" placeholder="Cognome" />
                <button id="createStudentBtn">Aggiungi Studente</button>
            </div>
        </div>

        <!-- Modal creazione lezione -->
        <div id="lessonModalOverlay" class="modal-overlay" style="display:none;">
            <div id="lessonModal" class="modal">
                <input type="datetime-local" id="lessonDateTime" />
                <button id="confirmLessonBtn">Crea</button>
            </div>
        </div>

        <!-- Modal presenze studenti -->
        <div id="attendanceModalOverlay" class="modal-overlay" style="display:none;">
            <div id="attendanceModal" class="modal">
                <h2 id="attendanceTitle"></h2>
                <ul id="attendanceList"></ul>
                <button id="closeAttendanceBtn">Chiudi</button>
            </div>
        </div>
    </main>

    <script>
        const classesGrid = document.getElementById('classesGrid');
        const addClassBtn = document.getElementById('addClassBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const newClassNameInput = document.getElementById('newClassName');
        const createClassBtn = document.getElementById('createClassBtn');

        const classDetail = document.getElementById('classDetail');
        const classNameEl = document.getElementById('className');
        const backToClassesBtn = document.getElementById('backToClasses');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const studentList = document.getElementById('studentList');

        const studentModalOverlay = document.getElementById('studentModalOverlay');
        const studentMatricolaInput = document.getElementById('studentMatricola');
        const studentNameInput = document.getElementById('studentName');
        const studentSurnameInput = document.getElementById('studentSurname');
        const createStudentBtn = document.getElementById('createStudentBtn');

        const lezioniList = document.getElementById('lezioniList');
        const createLessonBtn = document.getElementById('createLessonBtn');
        const lessonModalOverlay = document.getElementById('lessonModalOverlay');
        const lessonDateTimeInput = document.getElementById('lessonDateTime');
        const confirmLessonBtn = document.getElementById('confirmLessonBtn');

        const attendanceModalOverlay = document.getElementById('attendanceModalOverlay');
        const attendanceModal = document.getElementById('attendanceModal');
        const attendanceList = document.getElementById('attendanceList');
        const attendanceClassName = document.getElementById('attendanceTitle');
        const closeAttendanceBtn = document.getElementById('closeAttendanceBtn');

        let currentClassId = null;
        const classCards = new Map();

        // --- Classi ---
        function createClassCard(classe){
            const div = document.createElement('div');
            div.classList.add('class-card');

            const nome = document.createElement('h3');
            nome.textContent = classe.nome;
            div.appendChild(nome);

            const badge = document.createElement('span');
            badge.classList.add('badge');
            badge.textContent = `${classe.studenti || 0} studenti`;
            div.appendChild(badge);

            // Pulsante elimina classe
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '✖';
            deleteBtn.classList.add('delete-btn');
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.left = '8px';
            deleteBtn.style.bottom = '8px';
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                if(!confirm(`Vuoi eliminare la classe "${classe.nome}"?`)) return;
                try{
                    const res = await fetch(`http://localhost:3000/classi/${classe.id}`, {method:'DELETE'});
                    if(!res.ok) throw new Error();
                    fetchClassi();
                }catch(err){
                    console.error(err);
                    alert('Errore eliminazione classe');
                }
            };
            div.appendChild(deleteBtn);

            div.onclick = () => openClassDetail(classe.id, classe.nome);
            classCards.set(classe.id, div);
            return div;
        }

        function loadClasses(classi){
            classesGrid.innerHTML = '';
            classi.forEach(c => classesGrid.appendChild(createClassCard(c)));
        }

        async function fetchClassi(){
            try{
                const res = await fetch('http://localhost:3000/classi-con-numero-studenti');
                if(!res.ok) throw new Error();
                const data = await res.json();
                loadClasses(data);
                addClassBtn.style.display = 'inline-block';
            }catch(err){
                console.error(err);
                classesGrid.textContent = 'Errore caricamento classi';
            }
        }

        async function creaClasse(nome){
            if(!nome) return alert('Inserisci un nome valido');
            try{
                const res = await fetch('http://localhost:3000/classi',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({nome})
                });
                if(!res.ok) throw new Error();
                modalOverlay.style.display='none';
                fetchClassi();
            }catch(err){
                console.error(err);
                alert('Errore creazione classe');
            }
        }

        // --- Studenti ---
        async function fetchStudenti(classeId){
            try{
                const res = await fetch(`http://localhost:3000/classi/${classeId}/studenti`);
                const studenti = await res.json();
                loadStudentList(studenti);

                // Aggiorna badge
                const card = classCards.get(classeId);
                if(card){
                    const badge = card.querySelector('.badge');
                    badge.textContent = `${studenti.length} studenti`;
                }
            }catch(err){
                console.error(err);
                studentList.innerHTML = '<li>Errore caricamento studenti</li>';
            }
        }

        function loadStudentList(studenti){
            studentList.innerHTML = '';
            studenti.forEach(s=>{
                const li = document.createElement('li');
                li.textContent = `${s.matricola} - ${s.nome} ${s.cognome}`;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent='✖';
                deleteBtn.classList.add('delete-btn');
                deleteBtn.onclick=async()=>{
                    if(!confirm(`Vuoi eliminare lo studente "${s.nome} ${s.cognome}"?`)) return;
                    try{
                        const res = await fetch(`http://localhost:3000/studenti/${s.matricola}`,{method:'DELETE'});
                        if(!res.ok) throw new Error();
                        fetchStudenti(currentClassId);
                    }catch(err){
                        console.error(err);
                        alert('Errore eliminazione studente');
                    }
                };
                li.appendChild(deleteBtn);
                studentList.appendChild(li);
            });
        }

        async function creaStudente(matricola,nome,cognome){
            if(!matricola || !nome || !cognome) return alert('Inserisci tutti i dati');
            try{
                const res = await fetch(`http://localhost:3000/classi/${currentClassId}/studenti`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({matricola,nome,cognome})
                });
                if(!res.ok) throw new Error();
                studentModalOverlay.style.display='none';
                fetchStudenti(currentClassId);
            }catch(err){
                console.error(err);
                alert('Errore aggiunta studente');
            }
        }

        // --- Lezioni ---
        async function fetchLezioni(classeId){
            try{
                const res = await fetch(`http://localhost:3000/classi/${classeId}/lezioni`);
                const lezioni = await res.json();
                loadLezioni(lezioni);
            }catch(err){
                console.error(err);
                lezioniList.innerHTML='<li>Errore caricamento lezioni</li>';
            }
        }

        function loadLezioni(lezioni){
            lezioniList.innerHTML='';
            lezioni.forEach(l=>{
                const li = document.createElement('li');
                li.textContent = `${l.data}`;

                const deleteBtn=document.createElement('button');
                deleteBtn.textContent='✖';
                deleteBtn.classList.add('delete-btn');
                deleteBtn.onclick=async()=>{
                    if(!confirm('Vuoi eliminare questa lezione?')) return;
                    try{
                        const res=await fetch(`http://localhost:3000/lezioni/${l.id}`,{method:'DELETE'});
                        if(!res.ok) throw new Error();
                        fetchLezioni(currentClassId);
                    }catch(err){
                        console.error(err);
                        alert('Errore eliminazione lezione');
                    }
                };
                li.appendChild(deleteBtn);

                // Clic per aprire presenze
                li.onclick = (e)=>{
                    if(e.target !== deleteBtn) openAttendance(l.id, classNameEl.textContent);
                };

                lezioniList.appendChild(li);
            });
        }

        // --- Presenze ---
        function openAttendance(lezioneId, className) {
        // Nasconde tutto il resto
        classesGrid.style.display = 'none';
        classDetail.style.display = 'none';
        addClassBtn.style.display = 'none';

        attendanceClassName.textContent = `Presenze: `; 
        attendanceList.innerHTML = '';

        fetch(`http://localhost:3000/lezioni/${lezioneId}/presenze`)
            .then(res => res.json())
            .then(data => {
                data.forEach(studente => {
                    const li = document.createElement('li');

                    const nomeSpan = document.createElement('span');
                    nomeSpan.textContent = `${studente.nome} ${studente.cognome}`;
                    nomeSpan.style.marginRight = '10px';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = studente.presente === 1;

                    const statoSpan = document.createElement('span');
                    statoSpan.textContent = checkbox.checked ? 'Presente' : 'Assente';
                    statoSpan.style.marginLeft = '5px';

                    checkbox.addEventListener('change', ()=>{
                        statoSpan.textContent = checkbox.checked ? 'Presente' : 'Assente';
                        fetch(`http://localhost:3000/presenze/${lezioneId}/${studente.matricola}`, {
                            method:'PATCH',
                            headers:{'Content-Type':'application/json'},
                            body: JSON.stringify({presente: checkbox.checked ? 1 : 0})
                        });
                    });

                    li.appendChild(nomeSpan);
                    li.appendChild(checkbox);
                    li.appendChild(statoSpan);

                    attendanceList.appendChild(li);
                });

                attendanceModalOverlay.style.display='flex';
            });
    }

    closeAttendanceBtn.onclick = () => {
        attendanceModalOverlay.style.display = 'none';
        classDetail.style.display = currentClassId ? 'block' : 'none';
    };

        // --- UI ---
        function openClassDetail(classeId,classeNome){
            currentClassId=classeId;
            classesGrid.style.display='none';
            addClassBtn.style.display='none';
            classDetail.style.display='block';
            classNameEl.textContent=classeNome;
            fetchStudenti(classeId);
            fetchLezioni(classeId);
        }

        function closeClassDetail(){
            classDetail.style.display='none';
            classesGrid.style.display='grid';
            addClassBtn.style.display='inline-block';
        }

        // --- Eventi ---
        addClassBtn.onclick=()=>{
            modalOverlay.style.display='flex';
            newClassNameInput.value='';
            newClassNameInput.focus();
        };
        createClassBtn.onclick=()=>creaClasse(newClassNameInput.value.trim());
        modalOverlay.onclick=e=>{if(e.target===modalOverlay) modalOverlay.style.display='none';};
        backToClassesBtn.onclick=closeClassDetail;

        addStudentBtn.onclick=()=>{
            studentModalOverlay.style.display='flex';
            studentMatricolaInput.value='';
            studentNameInput.value='';
            studentSurnameInput.value='';
            studentMatricolaInput.focus();
        };
        createStudentBtn.onclick=()=>creaStudente(
            studentMatricolaInput.value.trim(),
            studentNameInput.value.trim(),
            studentSurnameInput.value.trim()
        );
        studentModalOverlay.onclick=e=>{if(e.target===studentModalOverlay) studentModalOverlay.style.display='none';};

        createLessonBtn.onclick=()=>{
            lessonModalOverlay.style.display='flex';
            lessonDateTimeInput.value='';
            lessonDateTimeInput.focus();
        };
        confirmLessonBtn.onclick=async()=>{
            const dataOra=lessonDateTimeInput.value;
            if(!dataOra) return alert('Inserisci data e ora');
            try{
                const res=await fetch(`http://localhost:3000/classi/${currentClassId}/lezioni`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({data:dataOra})
                });
                if(!res.ok) throw new Error();
                lessonModalOverlay.style.display='none';
                fetchLezioni(currentClassId);
            }catch(err){
                console.error(err);
                alert('Errore creazione lezione');
            }
        };
        lessonModalOverlay.onclick=e=>{if(e.target===lessonModalOverlay) lessonModalOverlay.style.display='none';};

        // --- Avvio ---
        fetchClassi();
    </script>
</body>
</html>